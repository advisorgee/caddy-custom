name: Build caddy-easydns

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'  # Nightly
  push:
    branches: "main"
    paths:
      - caddy-dns-easydns/Dockerfile

env:
  DOCKER_BUILDKIT: 1
  DOCKER_NAME: caddy-easydns
  DOCKER_DESCRIPTION: "Caddy Docker custom build with EasyDNS DNS and Security modules"
  GOTOOLCHAIN: auto
  DOCKERFILE_PATH: caddy-easydns/Dockerfile

jobs:
  update-dockerfile:
    name: Update Dockerfile to latest Caddy version
    runs-on: ubuntu-latest
    outputs:
      caddy_version: ${{ steps.latest_caddy.outputs.version }}
      updated: ${{ steps.update_dockerfile.outputs.updated }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get latest Caddy version from Docker Hub
        id: latest_caddy
        run: |
          latest=$(curl -s "https://registry.hub.docker.com/v2/repositories/library/caddy/tags?page_size=1" | jq -r '.results[0].name')
          if [[ -z "$latest" ]]; then
            echo "Failed to fetch Caddy version"
            exit 1
          fi
          echo "version=$latest" >> $GITHUB_OUTPUT

      - name: Get current Caddy version from Dockerfile
        id: current_caddy
        run: |
          current=$(grep -Eo 'caddy:[0-9]+\.[0-9]+\.[0-9]+' $DOCKERFILE_PATH | cut -d ':' -f2)
          if [[ -z "$current" ]]; then
            echo "Failed to extract current version"
            exit 1
          fi
          echo "version=$current" >> $GITHUB_OUTPUT

      - name: Update Dockerfile if needed
        id: update_dockerfile
        run: |
          latest="${{ steps.latest_caddy.outputs.version }}"
          current="${{ steps.current_caddy.outputs.version }}"
          updated="false"
          if [ "$latest" != "$current" ]; then
            sed -i "s/caddy:$current/caddy:$latest/" $DOCKERFILE_PATH
            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
*
î€€
